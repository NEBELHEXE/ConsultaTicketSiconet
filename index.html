<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta de Ticket</title>
  <link rel="stylesheet" href="ConsultaTicket.css">
</head>
<body>
  <!-- Header -->
  <div class="header">
    <a target="_blank" href="http://www.siconet.com.mx/">
      <img src="https://siconet.com.mx/wp-content/uploads/2016/12/transparente_2-01.png" alt="Siconet Logo">
    </a>
  </div>

  <main>
    <h1>Consulta tu Ticket</h1>

    <!-- Formulario de búsqueda -->
    <form id="ticket-form">
      <input type="text" id="ticket-id" placeholder="Ingresa tu ID" required>
      <button type="submit">Buscar</button>
    </form>

    <!-- Overlay de carga -->
    <div id="loading-overlay">
      <div class="spinner"></div>
      <div>Cargando datos, por favor espera...</div>
    </div>

    <!-- Tabla de ticket -->
    <table id="ticket-table" style="display:none;">
      <thead>
        <tr>
          <th>Empresa</th>
          <th>Fecha</th>
          <th>ID</th>
          <th>Urgencia</th>
          <th>Descripción</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <p id="no-result" style="display:none;">No se encontró ningún ticket con ese ID.</p>
  </main>

  <script>
    const FORM = document.getElementById('ticket-form');
    const INPUT = document.getElementById('ticket-id');
    const OVERLAY = document.getElementById('loading-overlay');
    const TABLE = document.getElementById('ticket-table');
    const TBODY = TABLE.querySelector('tbody');
    const NORESULT = document.getElementById('no-result');

    FORM.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = INPUT.value.trim();
      if (!id) return;

      TABLE.style.display = 'none';
      NORESULT.style.display = 'none';
      TBODY.innerHTML = '';
      OVERLAY.style.display = 'flex';

      try {
        const res = await fetch('https://script.google.com/macros/s/AKfycbxAwQsVPhC-xJgiytGNxdKIyBdiqNMH9T8ji8LvIESwKOw-q4qWsNyj2Fg_hPOVM5nT/exec');
        const data = await res.json();

        // Buscar ticket por ID
        const ticket = data.find(t => (t.ID || t.id || '').toString() === id);

        if (!ticket) {
          NORESULT.style.display = 'block';
        } else {
          const fechaTicket = new Date(ticket.Fecha || ticket.fecha);
          const diffDias = Math.floor((new Date() - fechaTicket) / (1000 * 60 * 60 * 24));

          let estado = '🫡';
          if (diffDias <= 1) estado = '🫡';
          else if (diffDias <= 3) estado = '😐';
          else if (diffDias <= 7) estado = '☹️';
          else estado = '💀';

          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${ticket.Empresa || ticket.empresa || ''}</td>
            <td>${fechaTicket.toLocaleDateString()}</td>
            <td>${ticket.ID || ticket.id || ''}</td>
            <td>${ticket.Urgencia || ticket.urgencia || ''}</td>
            <td>${ticket.Descripcion || ticket.descripcion || ''}</td>
            <td>${estado}</td>
          `;
          TBODY.appendChild(tr);
          TABLE.style.display = 'table';
        }
      } catch(err) {
        console.error(err);
        NORESULT.textContent = 'Error al consultar los datos.';
        NORESULT.style.display = 'block';
      } finally {
        OVERLAY.style.display = 'none';
      }
    });
  </script>
</body>
</html>
